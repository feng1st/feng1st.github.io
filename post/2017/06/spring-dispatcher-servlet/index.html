<!DOCTYPE html>
<html lang="utf-8">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="Hugo 0.25.1" />
    <link rel="shortcut icon" href="/images/favicon.ico">
    <link href="https://feng1st.github.io/index.xml" rel="alternate" type="application/rss+xml" title="知不足而后进" />
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    
    <script src="https://apis.google.com/js/platform.js" async defer>{lang: 'ja'}</script>
    
    <link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
    <script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <title>Spring DispatcherServlet相关知识点 | 知不足而后进</title>
  </head>
  <body>
    <div id="wrap">
      
      <header class="site-header">
        <div class="site-header-left">
          <a class="site-header-title" href="https://feng1st.github.io/">知不足而后进</a>
        </div>
      </header>
      <div class="container">
        <div id="main">

<div class="article">
  <header>
    <div class="article-header">
      <h1>Spring DispatcherServlet相关知识点</h1>
      <div class="article-meta">
        <span class="posttime">2017/06/25</span>
        
<div class="tags">
  <ul>
    
    <li>
        <a href="/tags/spring">Spring</a>
    </li>
    
    <li>
        <a href="/tags/dispatcherservlet">DispatcherServlet</a>
    </li>
    
  </ul>
</div>


      </div>
    </div>
    

  </header>
  <div class="content">
    

<h2 id="dispatcherservlet作用">DispatcherServlet作用</h2>

<ol>
<li>作为Spring MVC的集中访问点</li>
<li>通过HandlerMapping，将请求映射到Handler

<ul>
<li>返回一个HandlerExecutionChain，包含一个HandlerAdaptor和多个HandlerInterceptor</li>
</ul></li>
<li>通过不同的HandlerAdaptor，支持不同的处理器</li>
<li>通过ViewResolver，支持到具体视图的解析</li>
<li>通过HandlerExceptionResolver，实现对异常的处理</li>
</ol>

<p>每一部分都可以很方便的扩展</p>

<h2 id="dispatcherservlet流程">DispatcherServlet流程</h2>

<ol>
<li>请求被DispatcherServlet截获</li>
<li>DispatcherServlet在候选handlerMappings里面，找到第一个能够处理request的handlerMapping

<ul>
<li>常见的handlerMapping：

<ul>
<li>RequestMappingHandlerMapping: 通过@RequestMapping注解的Controller的方法

<ul>
<li>内部有一个url到HandlerMethod的映射，通过这个映射来判断是否能处理</li>
</ul></li>
<li>BeanNameUrlHandlerMapping: 通过web.xml配置的，从URL映射到bean。DispatcherServlet本身就是通过这种方式配置</li>
</ul></li>
</ul></li>
<li>handlerMapping构造一个HandlerExecutionChain

<ul>
<li>HandlerExecutionChain包含多个HandlerInterceptor和一个Handler

<ul>
<li>Handler是一个HandlerMethod，通过构造函数参数传入request</li>
<li>Spring MVC默认会注入一个ConversionServiceExposingInterceptor，用来处理日期、时间等格式转换</li>
</ul></li>
</ul></li>
<li>用HandlerAdaptor封装chain里的handler

<ul>
<li>不同的handler接口不同，通过adaptor统一接口</li>
<li>DispatcherServlet有一个HandlerAdaptor的列表，采用第一个.supports(handler)的HandlerAdaptor</li>
<li>HandlerMethod对应的是RequestMappingHandlerAdaptor</li>
</ul></li>
<li>依次执行各interceptor的preHandle，handlerAdaptor的handle和各interceptor的postHandle</li>
<li>HandlerAdaptor内部实例化一个ServletInvocableHandlerMethod

<ul>
<li>除了handler，还注入了HandlerMethodArgumentResolver列表、HandlerMethodReturnValueHandler列表以及DataBinderFactory</li>
</ul></li>
<li>ServletInvocableHandlerMethod.invokeAndHandle()里

<ol>
<li>用argumentResolvers和dataBinderFactory转化参数

<ul>
<li>用argumentResolvers解析参数</li>
<li>用dataBinder转化参数，包括：形参是vo，url参数是vo的属性，就会通过它来构建一个vo的实参</li>
</ul></li>
<li>调用用户在Controller的方法实现</li>
<li>用returnValueHandlers处理返回的结果

<ul>
<li>对于@ResponseBody类，直接转换成xml/json后写response，并返回null

<ul>
<li>使用HttpMessageConverter转换，比如StringHttpMessageConverter, MappingJackson2HttpMessageConverter</li>
</ul></li>
<li>否则返回一个ModelAndView</li>
</ul></li>
</ol></li>
<li>DispatcherServlet如果拿到的是一个ModelAndView，会通过ViewREsolver找到对应的view，来渲染model</li>
<li>HandlerMethodArgumentResolver和HandlerMethodReturnValueHandler的例子：RequestResponseBodyMethodProcessor

<ul>
<li>用来处理<code>@RequestBody</code>和<code>@ResponseBody</code></li>
<li>同时实现了HandlerMethodArgumentResolver和HandlerMethodReturnValueHandler接口</li>
<li>内部实现主要是读写Request和Response的Body，和使用HttpMessageConverter转换数据</li>
</ul></li>
</ol>

<h2 id="filter和handlerinterceptor">Filter和HandlerInterceptor</h2>

<p>总体来说，两者是类似的。不同点：</p>

<ol>
<li>Filter在web.xml定义，HandlerInterceptor在application context里定义</li>
<li>HandlerInterceptor接口分得更细</li>
<li>Filter一般用来处理请求内容和视图内容，比如压缩和分块</li>
<li>HandlerInterceptor用来处理一般性面向切面逻辑，比如授权</li>
</ol>

<pre><code>public interface HandlerInterceptor {
    boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception;
    void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception;
    void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception;
}
</code></pre>

<h2 id="参考资料">参考资料</h2>

<p><a href="http://www.chawenti.com/articles/23718.html">http://www.chawenti.com/articles/23718.html</a></p>

  </div>
  <footer>
    <div class="article-footer">
      
<div class="tags">
  <ul>
    
    <li>
        <a href="/tags/spring">Spring</a>
    </li>
    
    <li>
        <a href="/tags/dispatcherservlet">DispatcherServlet</a>
    </li>
    
  </ul>
</div>


      
      

      
      
      <div id="pagenavigation-next-prev">
        
        <div id="pagenavigation-next">
          <span class="pagenav-label">Previous</span>
          <a href="https://feng1st.github.io/post/2017/06/microservices/">微服务架构摘要</a>
        </div>
        
        
        <div id="pagenavigation-prev">
          <span class="pagenav-label">Next</span>
          <a href="https://feng1st.github.io/post/2017/06/spring-rest/">Spring实现RESTful Service笔记</a>
        </div>
        
      </div>
      
    </div>
  </footer>
</div>
        </div>
        <div class="sidebar">
  
  
  
  <div class="sidebar-content">
    <div class="sidebar-header">
      <span>Categories</span>
    </div>
    <div class="categories">
      <ul>
        
        <li>
          <a href="/categories/docker"><span></span>docker (1)</a>
        </li>
        
        <li>
          <a href="/categories/java"><span></span>java (2)</a>
        </li>
        
        <li>
          <a href="/categories/network"><span></span>network (2)</a>
        </li>
        
        <li>
          <a href="/categories/services"><span></span>services (3)</a>
        </li>
        
        <li>
          <a href="/categories/servlet"><span></span>servlet (3)</a>
        </li>
        
        <li>
          <a href="/categories/spring"><span></span>spring (2)</a>
        </li>
        
        <li>
          <a href="/categories/utilities"><span></span>utilities (1)</a>
        </li>
        
      </ul>
    </div>
  </div>
  
  <div class="sidebar-content">
    <div class="sidebar-header">
      <span>RSS</span>
    </div>
    <div id="rss">
      <a href="https://feng1st.github.io/index.xml" type="application/rss+xml" target="_blank">
        <i class="fa fa-rss-square fa-2x" aria-hidden="true"></i>
      </a>
    </div>
  </div>
</div>

      </div>
      <footer>
        <div id="site-footer-wrap">
          <div id="site-footer">
            <span>Powered by <a href="https://gohugo.io/">Hugo</a>.</span>
            <span>
              
              Copyright (c) 2017, <a href="https://feng1st.github.io/">知不足而后进</a>
              
            </span>
          </div>
        </div>
      </footer>
    </div>
  </body>
</html>

