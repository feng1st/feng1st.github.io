<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.25.1" />
    <meta name="description" content="">


    <title>微服务架构摘要 :: 知不足而后进</title>
    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
    <link href="/css/nucleus.css" rel="stylesheet">
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <link href="/css/hybrid.css" rel="stylesheet">
    <link href="/css/featherlight.min.css" rel="stylesheet">
    <link href="/css/horsey.css" rel="stylesheet">
    
    <link href="/css/theme.css" rel="stylesheet">
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <script src="/js/jquery-2.x.min.js"></script>
    <style type="text/css">
      :root #header + #content > #left > #rlblock_left {
        display:none !important;
      }
    </style>

    

    

  </head>
  <body class="" data-url="/services/2017-06-23-microservices/">
    <nav id="sidebar" class="">





<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
       
	 


    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>
<script type="text/javascript" src="/js/lunr.min.js"></script>
<script type="text/javascript" src="/js/horsey.js"></script>
<script type="text/javascript">
    var baseurl = "https:\/\/feng1st.github.io\/";
</script>
<script type="text/javascript" src="/js/search.js"></script>

    
  </div>

  
    <ul class="topics">
        
            <li data-nav-id="/" class="dd-item">
            <a href="/"><i class="fa fa-fw fa-home"></i></a>
            </li>
        
        
        
          
          


 
  
    
    <li data-nav-id="/java/" class="dd-item 
        
        
        
        ">
      <a href="/java/">
        <span>Java</span>

        
        

          
            <i class="fa fa-angle-right fa-lg category-icon"></i>
          

        

        
      </a>
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/java/2017-06-10-java-nio/" class="dd-item
     
      ">
        <a href="/java/2017-06-10-java-nio/">
        <span>Java NIO摘要</span> 
        
        </a></li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/java/2017-06-07-jvm-memory-gc/" class="dd-item
     
      ">
        <a href="/java/2017-06-07-jvm-memory-gc/">
        <span>Java内存模型和GC机制摘要</span> 
        
        </a></li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/network/" class="dd-item 
        
        
        
        ">
      <a href="/network/">
        <span>Network</span>

        
        

          
            <i class="fa fa-angle-right fa-lg category-icon"></i>
          

        

        
      </a>
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/network/2017-06-09-http-protocol/" class="dd-item
     
      ">
        <a href="/network/2017-06-09-http-protocol/">
        <span>HTTP协议摘要</span> 
        
        </a></li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/network/2017-06-08-tcp-ip-protocol/" class="dd-item
     
      ">
        <a href="/network/2017-06-08-tcp-ip-protocol/">
        <span>TCP/IP协议摘要</span> 
        
        </a></li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/servlet/" class="dd-item 
        
        
        
        ">
      <a href="/servlet/">
        <span>Servlet</span>

        
        

          
            <i class="fa fa-angle-right fa-lg category-icon"></i>
          

        

        
      </a>
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/servlet/2017-06-14-tomcat/" class="dd-item
     
      ">
        <a href="/servlet/2017-06-14-tomcat/">
        <span>Tomcat笔记</span> 
        
        </a></li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/servlet/2017-06-12-jetty/" class="dd-item
     
      ">
        <a href="/servlet/2017-06-12-jetty/">
        <span>Jetty笔记</span> 
        
        </a></li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/servlet/2017-06-11-servlet/" class="dd-item
     
      ">
        <a href="/servlet/2017-06-11-servlet/">
        <span>Servlet笔记</span> 
        
        </a></li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/services/" class="dd-item 
        parent
        
        
        ">
      <a href="/services/">
        <span>Services</span>

        
        

          
            <i class="fa fa-angle-down fa-lg category-icon"></i>
          

        

        
      </a>
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/services/2017-06-23-microservices/" class="dd-item
     active
      ">
        <a href="/services/2017-06-23-microservices/">
        <span>微服务架构摘要</span> 
        
        </a></li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/services/2017-06-19-microservices/" class="dd-item
     
      ">
        <a href="/services/2017-06-19-microservices/">
        <span>微服务架构笔记</span> 
        
        </a></li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/services/2017-06-18-soa/" class="dd-item
     
      ">
        <a href="/services/2017-06-18-soa/">
        <span>面向服务架构笔记</span> 
        
        </a></li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/services/2017-06-17-high-concurrency/" class="dd-item
     
      ">
        <a href="/services/2017-06-17-high-concurrency/">
        <span>高并发解决思路</span> 
        
        </a></li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/spring/" class="dd-item 
        
        
        
        ">
      <a href="/spring/">
        <span>Spring</span>

        
        

          
            <i class="fa fa-angle-right fa-lg category-icon"></i>
          

        

        
      </a>
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/spring/2017-06-26-spring-rest/" class="dd-item
     
      ">
        <a href="/spring/2017-06-26-spring-rest/">
        <span>Spring实现RESTful Service笔记</span> 
        
        </a></li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/spring/2017-06-25-spring-dispatcher-servlet/" class="dd-item
     
      ">
        <a href="/spring/2017-06-25-spring-dispatcher-servlet/">
        <span>Spring DispatcherServlet相关知识点</span> 
        
        </a></li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/docker/" class="dd-item 
        
        
        
        ">
      <a href="/docker/">
        <span>Docker</span>

        
        

          
            <i class="fa fa-angle-right fa-lg category-icon"></i>
          

        

        
      </a>
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docker/2017-06-27-dubbo-in-docker/" class="dd-item
     
      ">
        <a href="/docker/2017-06-27-dubbo-in-docker/">
        <span>Docker容器运行dubbo应用</span> 
        
        </a></li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/utilities/" class="dd-item 
        
        
        
        ">
      <a href="/utilities/">
        <span>Utilities</span>

        
        

          
            <i class="fa fa-angle-right fa-lg category-icon"></i>
          

        

        
      </a>
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/utilities/2017-06-22-plantuml/" class="dd-item
     
      ">
        <a href="/utilities/2017-06-22-plantuml/">
        <span>工具推荐：PlantUML，文本转UML图工具</span> 
        
        </a></li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
        

        
    </ul>
    
     
    <section id="footer">
      
    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
        
          <div id="top-bar">
            

            <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                <span id="sidebar-toggle-span">
                  <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                    <i class="fa fa-bars"></i>
                  </a>
                </span>
                <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
                <span class="links">
                







 <a href='/'>首页</a> > <a href='/services/'>Services</a> > 微服务架构摘要

 

 

   
                </span>
            </div>
            <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#单一框架有什么问题-微服务框架解决什么问题">单一框架有什么问题 / 微服务框架解决什么问题？</a></li>
<li><a href="#微服务框架">微服务框架</a>
<ul>
<li><a href="#伸缩模型">伸缩模型</a></li>
<li><a href="#微服务架构对数据库schema的影响">微服务架构对数据库schema的影响</a></li>
<li><a href="#微服务架构和soa的异同">微服务架构和SOA的异同</a></li>
<li><a href="#微服务的好处">微服务的好处</a></li>
<li><a href="#微服务的问题">微服务的问题</a></li>
</ul></li>
<li><a href="#api网关">API网关</a>
<ul>
<li><a href="#客户端直接和后端服务通讯的问题-api网关要解决的问题">客户端直接和后端服务通讯的问题 / API网关要解决的问题</a></li>
<li><a href="#挑战">挑战：</a></li>
<li><a href="#实现api网关">实现API网关</a></li>
</ul></li>
<li><a href="#进程间通讯-ipc">进程间通讯 IPC</a>
<ul>
<li><a href="#交互风格">交互风格</a></li>
<li><a href="#接口设计">接口设计</a></li>
<li><a href="#接口升级">接口升级</a></li>
<li><a href="#处理部分失败">处理部分失败</a></li>
<li><a href="#ipc技术">IPC技术</a>
<ul>
<li><a href="#异步-基于消息的通讯">异步、基于消息的通讯</a></li>
<li><a href="#同步-基于请求-响应的通讯">同步、基于请求/响应的通讯</a></li>
</ul></li>
</ul></li>
<li><a href="#服务发现">服务发现</a>
<ul>
<li><a href="#为什么需要服务发现">为什么需要服务发现</a></li>
<li><a href="#服务发现方式">服务发现方式</a></li>
<li><a href="#注册中心">注册中心</a></li>
</ul></li>
<li><a href="#事件驱动数据模型">事件驱动数据模型</a>
<ul>
<li><a href="#事件驱动架构">事件驱动架构</a></li>
<li><a href="#原子性">原子性</a></li>
</ul></li>
<li><a href="#部署">部署</a></li>
<li><a href="#重构单一架构到微服务架构">重构单一架构到微服务架构</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

          </div>
        
        
          <div id="tags">
            
              <a class="label label-default" href="https://feng1st.github.io//tags/microservices">Microservices</a>
            
          </div>
        
        <div id="body-inner">
          
            <h1>微服务架构摘要</h1>
          






<p>原文: <a href="https://www.nginx.com/blog/introduction-to-microservices/">https://www.nginx.com/blog/introduction-to-microservices/</a></p>

<h2 id="单一框架有什么问题-微服务框架解决什么问题">单一框架有什么问题 / 微服务框架解决什么问题？</h2>

<p>单一框架经过常年发展，扩充之后：</p>

<ol>
<li>过于复杂，难于理解和修改。修改容易引入bug</li>
<li>启动变慢，降低调试和开发速度</li>
<li>无法持续部署，无法快速升级。一个组件需要升级，整个应用都需要重新部署。部署后，因为受影响部分不明，需要更多的人工测试</li>
<li>无法根据不同组件的需求进行伸缩扩展。比如，部分组件是CPU密集型，部分组件是内存密集型；部分组件压力小，单个实例可以应付，部分组件压力大，有部署多个实例的需求</li>
<li>可靠性，组件异常（比如内存泄露），导致整个应用异常</li>
<li>难于升级到新的技术和框架</li>
</ol>

<h2 id="微服务框架">微服务框架</h2>

<ol>
<li>按功能划分，比如订单管理、客户端管理</li>
<li>每个微服务是一个单独的小应用</li>
<li>微服务对外暴露API，比如REST API
微服务之间可以通过暴露的API互相调用
微服务间还可以通过消息系统实现异步调用
外界一般不直接范围后端服务，而是通过API网关</li>
<li>微服务通常通过虚拟机或Docker部署</li>
</ol>

<h3 id="伸缩模型">伸缩模型</h3>

<p>x轴：水平复制，靠克隆伸缩。通过在负载均衡后部署多个实例，解决可用性和吞吐量的问题
y轴：功能解耦，靠拆分不同的事物伸缩。将单一应用通过功能/业务拆分成多个微服务
z轴：数据分区，靠拆分相似的事物伸缩</p>

<h3 id="微服务架构对数据库schema的影响">微服务架构对数据库schema的影响</h3>

<p>微服务架构要求每个微服务有自己单独的数据库schema
这是为了更彻底的解耦
但是不可避免的，多个微服务数据库间存在重复数据</p>

<h3 id="微服务架构和soa的异同">微服务架构和SOA的异同</h3>

<p>微服务架构和SOA在表现层有相似性：都是由多个服务构成
区别：
1. 微服务架构弃用了比较重的WS规范，采用轻量的协议，比如REST
2. 微服务架构弃用了ESB</p>

<h3 id="微服务的好处">微服务的好处</h3>

<ol>
<li>将单一应用解构成多个服务，让每一个服务面临的复杂度降低，变得可管理、可控制、可维护</li>
<li>开发方面：可以选用自己的技术，可以使用较新的技术</li>
<li>部署方面：可以单独部署，更容易部署和测试</li>
<li>伸缩方面：更容易按需扩展多实例</li>
</ol>

<h3 id="微服务的问题">微服务的问题</h3>

<p>下面这些问题都不难解决，但是需要清楚存在这些问题</p>

<ol>
<li>分布式架构下调用的开销，以及服务不可用的处理</li>
<li>数据库拆分后，分布式事务基本不采用，需要最终一致方案</li>
<li>测试更困难，可能需要启动服务本身和依赖服务（或者伪服务）</li>
<li>升级链，如果A依赖于B，需要先升级B，再升级A</li>
<li>部署，需要自动化工具</li>
</ol>

<h2 id="api网关">API网关</h2>

<p>门面模式 Facade</p>

<h3 id="客户端直接和后端服务通讯的问题-api网关要解决的问题">客户端直接和后端服务通讯的问题 / API网关要解决的问题</h3>

<ol>
<li>客户端需要调用多个后端服务，走广域网，非常慢</li>
<li>客户端代码复杂</li>
<li>客户端需要支持后端服务API所使用的通讯协议</li>
<li>后端服务接口无法自由变更，服务之间无法合并和拆分</li>
</ol>

<p>API网关除了解决上诉问题，还能：
1. 提供负载均衡、缓存、安全/权限控制，监控等
2. 为不同的客户端提供不同的接口</p>

<h3 id="挑战">挑战：</h3>

<ol>
<li>需要额外实现和维护一个高可用的组件</li>
<li>可能成为开发瓶颈</li>
</ol>

<h3 id="实现api网关">实现API网关</h3>

<ol>
<li>性能和高伸缩性

<ul>
<li>要支持异步、非阻塞通讯</li>
<li>技术选型：Netty, Spring Reactor, &hellip;</li>
</ul></li>
<li>使用反应式编程模型 Reactive Programming Model

<ul>
<li>需求：要支持直接转发单个请求；要支持调用多个请求，并聚合结果</li>
<li>需求：要支持彼此无关服务的并发调用；要支持有依赖关系服务的先后调用</li>
<li>不推荐使用回调实现异步（不直观、不容易理解、容易出错）</li>
<li>推荐使用Reactive</li>
<li>技术选型：CompletableFuture, RxJava</li>
</ul></li>
<li>服务调用

<ul>
<li>同步调用：HTTP、Thrift</li>
<li>异步、消息机制：JMS、AMQP、Zeromq</li>
<li>API网关需要这些服务通讯，也应支持上诉通讯机制</li>
</ul></li>
<li>服务发现

<ul>
<li>客户端发现：先请求服务地址列表，然后选择调用，负载均衡在客户端</li>
<li>服务端发现：注册总心选好后发给客户端，负载均衡在服务端</li>
<li>（这里的客户端指API网关）</li>
</ul></li>
<li>处理部分失败

<ul>
<li>面对服务慢或者不可用的处理。核心是不能阻塞API网关</li>
<li>要根据服务是否重要，选择：

<ul>
<li>直接返回给客户端错误</li>
<li>返回空、默认值、缓存值、备份数据等</li>
</ul></li>
<li>技术选型：Netflix Hystrix</li>
</ul></li>
</ol>

<h2 id="进程间通讯-ipc">进程间通讯 IPC</h2>

<h3 id="交互风格">交互风格</h3>

<table>
<thead>
<tr>
<th></th>
<th>一对一</th>
<th>一对多</th>
</tr>
</thead>

<tbody>
<tr>
<td>同步</td>
<td>Request/Response</td>
<td>&ndash;</td>
</tr>

<tr>
<td>异步</td>
<td>Notification</td>
<td>Publish/Subscribe</td>
</tr>

<tr>
<td></td>
<td>Request/Async response</td>
<td>Public/Async responses</td>
</tr>
</tbody>
</table>

<ol>
<li>Request/Response: 发送请求，等待响应。应有超时。线程阻塞</li>
<li>Notification (单向请求): 发送请求，不期待有响应</li>
<li>Request/Async response: 发送请求，不期待有即时响应。线程不阻塞</li>
<li>Publish/Subscribe: 发布请求，多个消费者消费</li>
<li>Publish/Async responses: 发布请求，等待多个响应。有超时</li>
</ol>

<h3 id="接口设计">接口设计</h3>

<ol>
<li>基于消息：定义消息channel和消息类型</li>
<li>基于HTTP：定义URL、请求和响应格式</li>
</ol>

<h3 id="接口升级">接口升级</h3>

<ol>
<li>向前兼容的小升级，比如增加/删除请求/响应字段：

<ul>
<li>缺失的字段采用默认值，忽略额外的字段</li>
<li>消息格式要支持，比如Protobuf，Json</li>
</ul></li>
<li>大的升级：要使用版本区分，服务要在一段时间内同时支持新旧版本接口</li>
</ol>

<h3 id="处理部分失败">处理部分失败</h3>

<ul>
<li>一定要有超时，不能无限阻塞</li>
<li>要限制客户端向同一服务的请求的数量，如果超限，直接失败</li>
<li>船舱隔离模式：

<ul>
<li>不同的调用分配到不同的线程池，不能因为慢速调用占满快速调用的线程池</li>
</ul></li>
<li>电路熔断器模式：

<ul>
<li>连续超时：断开</li>
<li>等待一段时间：半开放

<ul>
<li>又有超时：再断开</li>
<li>或不再超时：恢复</li>
</ul></li>
</ul></li>
<li>要根据服务是否重要，选择：

<ul>
<li>直接返回给客户端错误</li>
<li>返回空、默认值、缓存值、备份数据等</li>
</ul></li>
</ul>

<h3 id="ipc技术">IPC技术</h3>

<h4 id="异步-基于消息的通讯">异步、基于消息的通讯</h4>

<p>关键字：消息头、消息体、频道、生产者、消费者、broker、点对点、发布/订阅、……
这里不展开</p>

<ul>
<li>好处

<ol>
<li>客户端和服务解耦。客户端也不需要使用服务发现机制</li>
<li>消息缓存。支持消费者不实时在线</li>
<li>支持上面提到的所有交互风格</li>
<li>是显式IPC，不像有些RPC机制，尝试屏蔽是远程调用的事实。开发者有更好的意识和控制权</li>
</ol></li>
<li>缺点

<ol>
<li>额外的操作复杂性，需要引入一个高可用的消息中间件（这个应该不是问题）</li>
<li>用来实现Request/Response比较复杂：

<ul>
<li>客户端的请求消息要带上响应的channel和唯一id</li>
<li>服务的响应消息要带上这个唯一id，发送到响应channel</li>
<li>客户端要用唯一id，从响应channel找到匹配响应消息</li>
<li>不难理解，但是确实比直接基于请求/响应的机制更复杂</li>
</ul></li>
</ol></li>
</ul>

<h4 id="同步-基于请求-响应的通讯">同步、基于请求/响应的通讯</h4>

<ul>
<li>REST

<ul>
<li>核心是“资源”，基于HTTP请求类型和参数，实现资源的“增删改查”</li>
<li>REST定义也有不同的级别，从POST到同一URL，靠参数指定操作和对象，到靠HTTP请求类型指定操作，不同URL指定操作对象。不绝对</li>
<li>优势

<ul>
<li>基于HTTP，简单熟悉</li>
<li>构造请求简单，测试方便</li>
<li>天然支持请求/响应模式</li>
<li>防火墙友好</li>
<li>无中间层，系统结构简单</li>
</ul></li>
<li>缺点

<ul>
<li>对逻辑上的单向请求（Notification），服务端也要发响应</li>
<li>服务端必须实时在线</li>
<li>客户端和服务端耦合。需要有服务发现机制</li>
</ul></li>
<li>IDL：RAML和Swagger</li>
</ul></li>
<li>Thrift

<ul>
<li>支持请求/响应和通知（单向）</li>
<li>支持Json、二进制和压缩二进制。取舍是人工可读和占空间大小</li>
<li>支持HTTP和TCP。取舍是是否防火墙友好和效率</li>
</ul></li>
</ul>

<h2 id="服务发现">服务发现</h2>

<h3 id="为什么需要服务发现">为什么需要服务发现</h3>

<ol>
<li>集群动态伸缩</li>
<li>基于Container的部署方式，IP和端口也是动态分配的</li>
</ol>

<h3 id="服务发现方式">服务发现方式</h3>

<ol>
<li>客户端发现模式

<ol>
<li>服务端在启动时向注册中心注册、停止时取消注册、靠心跳刷新</li>
<li>客户端向注册中心获取服务端列表</li>
<li>客户端主动负载均衡，比如采用一致性hash</li>
<li>优点：直接</li>
<li>优点：可根据业务灵活选用负载均衡策略</li>
<li>缺点：客户端和注册中心耦合</li>
<li>实现技巧：客户端和服务端均在注册中心注册，便于服务端变更时，注册中心主动推送。参考dubbo</li>
</ol></li>
<li>服务端发现模式

<ol>
<li>客户端请求发给负载均衡服务器</li>
<li>负载均衡服务器负责和注册中心通讯</li>
<li>优点：客户端和服务发现逻辑解耦</li>
<li>缺点：需要高可用的负载均衡服务器</li>
</ol></li>
</ol>

<h3 id="注册中心">注册中心</h3>

<p>参考：Zookeeper
注册方式：
1. 自注册：优点：直接；缺点：服务和注册中心耦合
2. 第三方组件注册：优点：解耦；缺点：额外高可用组件</p>

<h2 id="事件驱动数据模型">事件驱动数据模型</h2>

<p>数据随着微服务拆分，带来下面的挑战：
1. 跨服务事务的一致性
    - 2PC 两阶段提交在此情况下不可用，CAP要优先满足A，或者BASE
2. 怎样从多个服务请求数据</p>

<h3 id="事件驱动架构">事件驱动架构</h3>

<ol>
<li>将跨服务的事务划分为多步</li>
<li>每一步，一个微服务更新业务对象（本地事务），同时产生一个事件以激发下一步</li>
<li>事件通过消息系统传递</li>
</ol>

<p>例子：创建订单
1. 订单服务创建订单，状态为NEW，然后发布订单创建消息到消息系统
2. 客户服务收到订单创建消息，预留订单费用，发布预留订单费用消息
    - 预留费用至少涉及到两个表，是一个本地事务。要能想到
    - 1. <code>customer.credit_limit - sum(reserved_credit.amount) &gt;= order_total</code>
    - 2. <code>insert into reserved_credit (... amount) values (... order_total)</code>
    - 如果要保证事务发送成功，事务里还要包括第3个表，事务表（见下）
    - 
<figure >
    <a href="Richardson-microservices-part5-credit-check-2-e1449727579423.png">
        <img src="Richardson-microservices-part5-credit-check-2-e1449727579423.png" />
    </a>
    
</figure>

3. 订单服务收到预留订单费用消息，将订单状态更新为OPEN</p>

<p>因为服务统一向消息系统发事务，可以有一个视图服务，订阅这些事务，更新事务，实现跨服务查询</p>

<h3 id="原子性">原子性</h3>

<ol>
<li>使用本地事务发布事件

<ul>
<li>将操作业务对象和插入事件表放到一个事务里面</li>
<li>
<figure >
    <a href="Richardson-microservices-part5-local-transaction-e1449727484579.png">
        <img src="Richardson-microservices-part5-local-transaction-e1449727484579.png" />
    </a>
    
</figure>
</li>
<li>事件发布者轮询事件表，确保事件发送成功 at least once</li>
</ul></li>
<li>挖掘数据库事务日志

<ul>
<li>实现较复杂</li>
</ul></li>
<li>使用事件源

<ul>
<li>保存的不是结果，而是操作步骤</li>
<li>逻辑较复杂</li>
</ul></li>
</ol>

<h2 id="部署">部署</h2>

<ol>
<li>每微服务一虚拟机

<ul>
<li>隔离性高</li>
<li>开销大</li>
</ul></li>
<li>每微服务一容器

<ul>
<li>隔离性低</li>
<li>开销小</li>
<li>实现：Docker</li>
</ul></li>
</ol>

<h2 id="重构单一架构到微服务架构">重构单一架构到微服务架构</h2>

<ol>
<li>新功能直接使用微服务实现

<ul>
<li>前端路由请求到旧单一应用和新微服务</li>
<li>新微服务使用“胶水代码”访问旧单一应用</li>
<li>访问旧单一应用的数据

<ul>
<li>远程调用旧单一应用接口</li>
<li>直接访问旧单一应用数据库</li>
<li>维护独立数据，和旧数据库同步</li>
</ul></li>
</ul></li>
<li>拆分前后端

<ul>
<li>最容易拆的是表现层和逻辑层。逻辑层和数据层稍难</li>
<li>表现层拆出来后便于独立开发和A/B测试</li>
</ul></li>
<li>拆模块

<ul>
<li>优先级

<ul>
<li>先拆变化频繁的，便于加速后继开发</li>
<li>再拆资源要求不一样的，便于分开部署和伸缩</li>
<li>再拆和其它模块交互较粗的，比如通过消息系统交互的</li>
</ul></li>
<li>步骤

<ol>
<li>模块和剩余部分改成IPC通讯</li>
<li>将模块独立成微服务</li>
</ol></li>
</ul></li>
</ol>


<footer class=" footline" >
	
</footer>



      </div>
    </div>

    
 
    

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


        
            <a class="nav nav-prev" href="/services/" title="Services"> <i class="fa fa-chevron-left"></i></a>
        
        
            <a class="nav nav-next" href="/services/2017-06-19-microservices/" title="微服务架构笔记" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
        
    </div>

    </section>
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js"></script>
    <script src="/js/featherlight.min.js"></script>
    <script src="/js/html5shiv-printshiv.min.js"></script>
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js"></script>
    <script src="/js/learn.js"></script>
    <script src="/js/hugo-learn.js"></script>

    
    <link href="/mermaid/mermaid.css" type="text/css" rel="stylesheet"/>
    <script src="/mermaid/mermaid.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    

    

  </body>
</html>

